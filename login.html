<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timeless Solutions â€” Login</title>
  <!-- Tailwind CDN for fast iteration; swap to your build pipeline later -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent:#f5c400; /* construction yellow */ }
    html,body { height:100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
    .ts-accent { color: #1b1b1b; background: var(--accent); }
    .focus-ring:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
  </style>
</head>
<body class="min-h-full bg-neutral-50 text-neutral-900">
  <!-- Shell -->
  <div class="min-h-full flex items-center justify-center py-12 px-4">
    <main class="w-full max-w-md">
      <!-- Brand -->
      <div class="flex flex-col items-center gap-3 mb-8">
        <div class="h-12 w-12 rounded-xl ts-accent grid place-items-center font-bold">TS</div>
        <h1 class="text-2xl font-semibold">Timeless Solutions</h1>
        <p class="text-neutral-600 text-center">Join the private construction network.</p>
      </div>

      <!-- Card -->
      <section class="bg-white shadow-lg rounded-2xl p-6 ring-1 ring-black/5">
        <header class="mb-4">
          <h2 class="text-lg font-semibold">Hello, client of Timeless Solutions ðŸ‘‹</h2>
          <p class="text-sm text-neutral-600">Log in with your email and password.</p>
        </header>

        <!-- Alerts -->
        <div id="alert" class="hidden mb-4 rounded-lg border px-3 py-2 text-sm"></div>

        <!-- Login Form -->
        <form id="loginForm" novalidate>
          <div class="space-y-4">
            <div>
              <label for="email" class="block text-sm font-medium">Email</label>
              <input id="email" name="email" type="email" autocomplete="email" required
                     class="mt-1 block w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm focus:ring-0 focus:border-neutral-800"
                     placeholder="you@example.com" />
              <p id="emailError" class="mt-1 hidden text-xs text-red-600">Please enter a valid email.</p>
            </div>

            <div>
              <div class="flex items-center justify-between">
                <label for="password" class="block text-sm font-medium">Password</label>
                <a href="forgot-password.html" class="text-sm text-neutral-700 hover:underline">Forgot password?</a>
              </div>
              <input id="password" name="password" type="password" autocomplete="current-password" required minlength="6"
                     class="mt-1 block w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm focus:border-neutral-800 focus:outline-none focus:ring-0"
                     placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
              <p id="passwordError" class="mt-1 hidden text-xs text-red-600">Password must be at least 6 characters.</p>
            </div>

            <label class="inline-flex items-center gap-2 text-sm text-neutral-700">
              <input id="rememberMe" type="checkbox" class="h-4 w-4 rounded border-neutral-300 text-neutral-900 focus:ring-0" />
              Keep me signed in on this device
            </label>

            <button id="submitBtn" type="submit"
                    class="w-full rounded-lg ts-accent px-3 py-2 text-sm font-semibold hover:brightness-95 focus-ring disabled:opacity-60 disabled:cursor-not-allowed">
              <span id="btnText">Log In</span>
              <span id="btnSpinner" class="hidden ml-2 inline-block h-4 w-4 animate-spin border-2 border-neutral-900 border-t-transparent rounded-full align-[-2px]"></span>
            </button>
          </div>
        </form>

        <div class="mt-5 text-center text-sm">
          <span class="text-neutral-600">Donâ€™t have an account?</span>
          <a href="signup.html" class="font-medium text-neutral-800 hover:underline">Sign up</a>
        </div>
      </section>

      <!-- Demo Users helper -->
      <details class="mt-4 text-sm text-neutral-600">
        <summary class="cursor-pointer">Demo accounts (for local testing)</summary>
        <ul class="list-disc ml-5 mt-2">
          <li><code>paid.contractor@example.com / Passw0rd!</code> â€” contractor (approved + paid)</li>
          <li><code>unpaid.contractor@example.com / Passw0rd!</code> â€” contractor (approved, payment due)</li>
          <li><code>dev@example.com / Passw0rd!</code> â€” developer (approved)</li>
          <li><code>pending@example.com / Passw0rd!</code> â€” pending approval</li>
        </ul>
      </details>
    </main>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // --- Supabase client ---
    const supabase = createClient(
      "https://twxpfobmjaaoaixwqcfn.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3eHBmb2JtamFhb2FpeHdxY2ZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NDM1MTcsImV4cCI6MjA3MTMxOTUxN30._mVC0QPx23QpG_4Y-VKb20mWCVTGAe_JRwyFyD0vHxA",
      {
        // Optional: persist session if "remember me" is checked
        auth: { persistSession: true, autoRefreshToken: true }
      }
    );

    // ============================
    // UI Helpers
    // ============================
    const alertEl = document.getElementById("alert");
    function showAlert(type, message) {
      const styles = {
        error: "border-red-300 bg-red-50 text-red-800",
        success: "border-green-300 bg-green-50 text-green-800",
        info: "border-neutral-300 bg-neutral-50 text-neutral-800"
      };
      alertEl.className = `mb-4 rounded-lg border px-3 py-2 text-sm ${styles[type] || styles.info}`;
      alertEl.textContent = message;
      alertEl.classList.remove("hidden");
    }
    function clearAlert() {
      alertEl.classList.add("hidden");
      alertEl.textContent = "";
    }

    function setLoading(isLoading) {
      const btn = document.getElementById("submitBtn");
      document.getElementById("btnText").textContent = isLoading ? "Signing in..." : "Log In";
      document.getElementById("btnSpinner").classList.toggle("hidden", !isLoading);
      btn.disabled = isLoading;
    }

    // ============================
    // Form Handling
    // ============================
    const form = document.getElementById("loginForm");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const emailError = document.getElementById("emailError");
    const passwordError = document.getElementById("passwordError");
    const rememberMe = document.getElementById("rememberMe");

    function validate() {
      let valid = true;
      clearAlert();

      if (!emailInput.value || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value)) {
        emailError.classList.remove("hidden");
        emailInput.setAttribute("aria-invalid", "true");
        valid = false;
      } else {
        emailError.classList.add("hidden");
        emailInput.removeAttribute("aria-invalid");
      }

      if (!passwordInput.value || passwordInput.value.length < 6) {
        passwordError.classList.remove("hidden");
        passwordInput.setAttribute("aria-invalid", "true");
        valid = false;
      } else {
        passwordError.classList.add("hidden");
        passwordInput.removeAttribute("aria-invalid");
      }
      return valid;
    }

    // Optional: apply "remember me" to Supabase session storage behavior
    rememberMe.addEventListener("change", () => {
      // When unchecked, store session in memory only (clears on refresh).
      const storage = rememberMe.checked ? localStorage : sessionStorage;
      supabase.auth.setSessionStorage(storage);
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!validate()) return;

      setLoading(true);

      try {
        const email = emailInput.value.trim();
        const password = passwordInput.value;

        // Sign in
        const { data: signInData, error: signInErr } = await supabase.auth.signInWithPassword({ email, password });
        if (signInErr) {
          // Show Supabase error message if available; otherwise generic
          showAlert("error", signInErr.message || "Invalid email or password.");
          return;
        }

        const userId = signInData?.user?.id;
        if (!userId) {
          showAlert("error", "Could not retrieve user session. Try again.");
          return;
        }

        // Fetch profile: role + payment status
        const { data: profile, error: profErr } = await supabase
          .from("profiles")
          .select("role, status, is_paid")
          .eq("id", userId)
          .maybeSingle();

        if (profErr) {
          showAlert("error", "Profile lookup failed. Please try again.");
          return;
        }

        // Gate access
        if (!profile || profile.status !== "approved") {
          showAlert("error", "Your application is still pending approval. Youâ€™ll hear back within 24â€“48 hours.");
          return;
        }

        if (profile.role === "contractor" && !profile.is_paid) {
          showAlert("error", "Membership payment required before access.");
          // TODO: window.location.href = "payment.html"; // when payment page exists
          return;
        }

        // âœ… Success
        showAlert("success", `Welcome back, ${profile.role}! Youâ€™re cleared for access.`);

        // TODO: Redirect to role dashboard once built
        // if (profile.role === "developer") window.location.href = "developer-dashboard.html";
        // else window.location.href = "contractor-dashboard.html";
      } catch (err) {
        console.error(err);
        showAlert("error", "Unexpected error. Please try again.");
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
