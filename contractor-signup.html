<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timeless Solutions — Contractor Signup</title>
  <!-- Tailwind CDN for quick iteration -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent:#f5c400; } /* construction yellow */
    html,body { height:100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; }
    .ts-accent { background: var(--accent); color:#1b1b1b; }
    .focus-ring:focus-visible { outline:2px solid var(--accent); outline-offset:2px; }
    .step { display:flex; align-items:center; gap:.5rem; }
    .step-dot { height:1.25rem; width:1.25rem; border-radius:9999px; display:grid; place-items:center; font-size:.75rem; }
  </style>
</head>
<body class="min-h-full bg-neutral-50 text-neutral-900">
  <div class="min-h-full flex items-center justify-center py-12 px-4">
    <main class="w-full max-w-2xl">
      <!-- Brand -->
      <div class="flex flex-col items-center gap-3 mb-8">
        <div class="h-12 w-12 rounded-xl ts-accent grid place-items-center font-bold">TS</div>
        <h1 class="text-2xl font-semibold">Timeless Solutions</h1>
        <p class="text-neutral-600 text-center">Join the private construction network.</p>
      </div>

      <!-- Card -->
      <section class="bg-white shadow-lg rounded-2xl p-6 ring-1 ring-black/5">
        <!-- Stepper -->
        <nav class="flex items-center justify-center gap-6 mb-6 text-sm">
          <div class="step">
            <span class="step-dot ts-accent font-semibold">1</span>
            <span>Choose Role</span>
          </div>
          <div class="text-neutral-300">—</div>
          <div class="step">
            <span class="step-dot ts-accent font-semibold">2</span>
            <span>Contractor Details</span>
          </div>
          <div class="text-neutral-300">—</div>
          <div class="step">
            <span class="step-dot bg-neutral-200 text-neutral-700">3</span>
            <span>Pending Review</span>
          </div>
        </nav>

        <header class="mb-4">
          <h2 class="text-lg font-semibold">Contractor Signup</h2>
          <p class="text-sm text-neutral-600">Tell us about your company. Approval usually takes 24–48 hours.</p>
        </header>

        <!-- Alerts -->
        <div id="alert" class="hidden mb-4 rounded-lg border px-3 py-2 text-sm"></div>

        <!-- Form -->
        <form id="contractorForm" novalidate class="space-y-5">
          <!-- Row 1 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="fullName" class="block text-sm font-medium">Full Name *</label>
              <input id="fullName" name="fullName" type="text" required
                     class="mt-1 w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm focus:border-neutral-800 focus:outline-none"
                     placeholder="Jane Doe" />
              <p data-err="fullName" class="hidden mt-1 text-xs text-red-600">Full name is required.</p>
            </div>
            <div>
              <label for="companyName" class="block text-sm font-medium">Company Name *</label>
              <input id="companyName" name="companyName" type="text" required
                     class="mt-1 w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm focus:border-neutral-800 focus:outline-none"
                     placeholder="Doe Construction LLC" />
              <p data-err="companyName" class="hidden mt-1 text-xs text-red-600">Company name is required.</p>
            </div>
          </div>

          <!-- Row 2 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="email" class="block text-sm font-medium">Email *</label>
              <input id="email" name="email" type="email" required autocomplete="email"
                     class="mt-1 w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm focus:border-neutral-800 focus:outline-none"
                     placeholder="you@example.com" />
              <p data-err="email" class="hidden mt-1 text-xs text-red-600">Enter a valid email.</p>
            </div>
            <div>
              <label for="phone" class="block text-sm font-medium">Phone *</label>
              <input id="phone" name="phone" type="tel" required
                     class="mt-1 w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm focus:border-neutral-800 focus:outline-none"
                     placeholder="(555) 123-4567" />
              <p data-err="phone" class="hidden mt-1 text-xs text-red-600">Enter a valid phone number.</p>
            </div>
          </div>

          <!-- Row 3 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="password" class="block text-sm font-medium">Password *</label>
              <input id="password" name="password" type="password" required minlength="6" autocomplete="new-password"
                     class="mt-1 w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm focus:border-neutral-800 focus:outline-none"
                     placeholder="••••••••" />
              <p data-err="password" class="hidden mt-1 text-xs text-red-600">Min 6 characters.</p>
            </div>
            <div>
              <label for="confirmPassword" class="block text-sm font-medium">Confirm Password *</label>
              <input id="confirmPassword" name="confirmPassword" type="password" required minlength="6" autocomplete="new-password"
                     class="mt-1 w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm focus:border-neutral-800 focus:outline-none"
                     placeholder="••••••••" />
              <p data-err="confirmPassword" class="hidden mt-1 text-xs text-red-600">Passwords must match.</p>
            </div>
          </div>

          <!-- Row 4 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="trade" class="block text-sm font-medium">Trade / Specialty *</label>
              <select id="trade" name="trade" required
                      class="mt-1 w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm focus:border-neutral-800 focus:outline-none">
                <option value="">Select trade</option>
                <option>General Contractor</option>
                <option>Electrical</option>
                <option>Plumbing</option>
                <option>HVAC</option>
                <option>Roofing</option>
                <option>Concrete</option>
                <option>Framing</option>
                <option>Landscaping</option>
                <option>Drywall/Paint</option>
                <option>Flooring</option>
                <option>Masonry</option>
                <option>Glazing</option>
                <option>Other</option>
              </select>
              <p data-err="trade" class="hidden mt-1 text-xs text-red-600">Select your trade.</p>
            </div>
            <div>
              <label for="years" class="block text-sm font-medium">Years in Business *</label>
              <input id="years" name="years" type="number" min="0" max="100" required
                     class="mt-1 w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm focus:border-neutral-800 focus:outline-none"
                     placeholder="5" />
              <p data-err="years" class="hidden mt-1 text-xs text-red-600">Enter 0–100.</p>
            </div>
          </div>

          <!-- Row 5 -->
          <div>
            <label for="zips" class="block text-sm font-medium">Service Area ZIP Code(s) *</label>
            <input id="zips" name="zips" type="text" required
                   class="mt-1 w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm focus:border-neutral-800 focus:outline-none"
                   placeholder="78249, 78250, 78251" />
            <p class="mt-1 text-xs text-neutral-500">Comma-separated (5‑digit ZIPs).</p>
            <p data-err="zips" class="hidden mt-1 text-xs text-red-600">Enter comma-separated 5‑digit ZIPs.</p>
          </div>

          <!-- Row 6 -->
          <div>
            <label for="license" class="block text-sm font-medium">License/Insurance (optional)</label>
            <input id="license" name="license" type="file" accept=".pdf,.jpg,.jpeg,.png"
                   class="mt-1 block w-full text-sm file:mr-3 file:rounded-lg file:border-0 file:px-3 file:py-2 file:bg-neutral-100 file:text-neutral-800 hover:file:bg-neutral-200" />
            <p class="mt-1 text-xs text-neutral-500">You can add proof later in My Account.</p>
          </div>

          <!-- Terms -->
          <div class="flex items-start gap-3">
            <input id="terms" name="terms" type="checkbox" required
                   class="mt-1 h-4 w-4 rounded border-neutral-300 text-neutral-900 focus:ring-0 focus:ring-offset-0" />
            <label for="terms" class="text-sm text-neutral-700">
              I agree to the <a href="#" class="underline">Terms</a> and <a href="#" class="underline">Privacy Policy</a>.
            </label>
          </div>
          <p data-err="terms" class="hidden -mt-3 text-xs text-red-600">You must accept the terms.</p>

          <!-- Submit -->
          <button type="submit" class="w-full rounded-lg ts-accent px-3 py-2 text-sm font-semibold hover:brightness-95 focus-ring">
            Submit Application
          </button>

          <!-- Links -->
          <div class="text-center text-sm">
            <a href="signup.html" class="text-neutral-800 hover:underline">← Switch Role</a>
            <span class="mx-2 text-neutral-300">•</span>
            <a href="login.html" class="text-neutral-800 hover:underline">Already have an account? Log in</a>
          </div>
        </form>

        <!-- Success state -->
        <div id="successState" class="hidden">
          <div class="flex items-center gap-3 mb-2">
            <div class="h-8 w-8 rounded-full ts-accent grid place-items-center font-bold">✓</div>
            <h3 class="text-lg font-semibold">Application submitted</h3>
          </div>
          <p class="text-sm text-neutral-700">
            Your application is <span class="font-medium">pending approval</span>. You’ll hear back within <span class="font-medium">24–48 hours</span>.
          </p>
          <p class="mt-2 text-sm text-neutral-700">
            After approval, you’ll complete your contractor membership payment to access private projects.
          </p>
          <div class="mt-5">
            <a href="login.html" class="inline-flex items-center gap-2 rounded-lg border border-neutral-300 px-3 py-2 text-sm hover:bg-neutral-50">
              Back to Login
            </a>
          </div>
        </div>
      </section>

      <p class="mt-4 text-xs text-neutral-500 text-center">
        Contractors gain access only after approval and membership payment.
      </p>
    </main>
  </div>

<script type="module">
// ===========================
// Supabase init (your keys)
// ===========================
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://twxpfobmjaaoaixwqcfn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3eHBmb2JtamFhb2FpeHdxY2ZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NDM1MTcsImV4cCI6MjA3MTMxOTUxN30._mVC0QPx23QpG_4Y-VKb20mWCVTGAe_JRwyFyD0vHxA",
  { auth: { persistSession: true, autoRefreshToken: true } }
);

// If your project requires email confirmation, there usually WON'T be a session
// right after signUp(). That's fine—this script still inserts the application.
const REQUIRES_EMAIL_CONFIRM = true;

// ===========================
// UI helpers (uses your IDs)
// ===========================
const form = document.getElementById("contractorForm");
const successState = document.getElementById("successState");
const alertEl = document.getElementById("alert");

function showAlert(type, message) {
  const styles = {
    error: "border-red-300 bg-red-50 text-red-800",
    success: "border-green-300 bg-green-50 text-green-800",
    info: "border-neutral-300 bg-neutral-50 text-neutral-800"
  };
  alertEl.className = `mb-4 rounded-lg border px-3 py-2 text-sm ${styles[type] || styles.info}`;
  alertEl.textContent = message;
  alertEl.classList.remove("hidden");
}
function clearAlert() {
  alertEl.classList.add("hidden");
  alertEl.textContent = "";
}

// Simple inline error toggle (expects <p data-err="fieldName"> helpers in your HTML)
const err = (name, show, msg) => {
  const el = document.querySelector(`[data-err="${name}"]`);
  if (!el) return;
  if (msg) el.textContent = msg;
  el.classList.toggle("hidden", !show);
};

// ===========================
// Validation (same rules you used)
// ===========================
function validEmail(v) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
function validPhone(v) { const d = (v || "").replace(/\D/g, ""); return d.length >= 10 && d.length <= 15; }
function validZips(v) { return !!v && v.split(",").map(s => s.trim()).every(s => /^\d{5}$/.test(s)); }

function validate() {
  let ok = true;
  clearAlert();

  const fullName = document.getElementById("fullName").value.trim();
  const companyName = document.getElementById("companyName").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const password = document.getElementById("password").value;
  const confirmPassword = document.getElementById("confirmPassword").value;
  const trade = document.getElementById("trade").value;
  const years = document.getElementById("years").value;
  const zips = document.getElementById("zips").value.trim();
  const terms = document.getElementById("terms").checked;

  if (!fullName) { err("fullName", true); ok = false; } else err("fullName", false);
  if (!companyName) { err("companyName", true); ok = false; } else err("companyName", false);
  if (!validEmail(email)) { err("email", true); ok = false; } else err("email", false);
  if (!validPhone(phone)) { err("phone", true); ok = false; } else err("phone", false);
  if (!password || password.length < 6) { err("password", true); ok = false; } else err("password", false);
  if (confirmPassword !== password) { err("confirmPassword", true); ok = false; } else err("confirmPassword", false);
  if (!trade) { err("trade", true); ok = false; } else err("trade", false);

  const yearsNum = Number(years);
  if (!(years !== "" && yearsNum >= 0 && yearsNum <= 100)) { err("years", true); ok = false; } else err("years", false);

  if (!validZips(zips)) { err("zips", true); ok = false; } else err("zips", false);
  if (!terms) { err("terms", true); ok = false; } else err("terms", false);

  return ok;
}

// ===========================
// Optional upload helper
// Only works when a session exists (i.e., email confirmation OFF).
// If no session, we skip and still insert the application.
// ===========================
async function maybeUploadToApplicationsBucket(file) {
  if (!file) return { path: null, skipped: true };
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) return { path: null, skipped: true }; // RLS needs auth to write storage

  const safeName = file.name.replace(/\s+/g, "_");
  const userId = session.user.id;
  const path = `${userId}/${crypto.randomUUID()}_${safeName}`;

  const { data, error } = await supabase.storage.from("applications").upload(path, file, { upsert: false });
  if (error) throw error;
  return { path: data.path, skipped: false };
}

// ===========================
// Submit handler
// 1) Create Auth user with password they typed
// 2) Upload optional file (if session exists)
// 3) Insert application row
// ===========================
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!validate()) return;

  // Gather fields
  const payload = {
    role: "contractor",
    full_name: document.getElementById("fullName").value.trim(),
    company_name: document.getElementById("companyName").value.trim(),
    email: document.getElementById("email").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    trade: document.getElementById("trade").value,
    years_in_business: Number(document.getElementById("years").value || 0),
    service_zips: document.getElementById("zips").value.split(",").map(s => s.trim()).filter(Boolean),
  };
  const password = document.getElementById("password").value;
  const licenseFile = document.getElementById("license")?.files?.[0] || null;

  try {
    // ---- 1) Auth sign-up (this saves the SAME password for login) ----
    // Also send role in user_metadata for your trigger (if you added one).
    const { data: signUpData, error: signUpErr } = await supabase.auth.signUp({
      email: payload.email,
      password,
      options: {
        data: { role: "contractor" },
        // If you want an email link to send them back to your site after email confirm:
        // emailRedirectTo: "https://timelessfieldsolutions.com/login.html"
      }
    });
    if (signUpErr) {
      // Common: "User already registered"
      showAlert("error", signUpErr.message || "Could not create account.");
      return;
    }

    // We might NOT have a session if email confirmation is required.
    // That's okay—we can still insert an application row (policy allows anon insert).
    // Optional storage upload only if we do have a session:
    let license_url = null;
    try {
      const up = await maybeUploadToApplicationsBucket(licenseFile);
      license_url = up.path || null;
    } catch (upErr) {
      // Non-fatal; we still insert application without file path
      console.warn("Upload skipped/failed:", upErr?.message);
    }

    // ---- 2) Insert application row (public.applications) ----
    const { error: appErr } = await supabase.from("applications").insert([{
      role: payload.role,
      full_name: payload.full_name,
      company_name: payload.company_name,
      email: payload.email,
      phone: payload.phone,
      trade: payload.trade,
      years_in_business: payload.years_in_business,
      service_zips: payload.service_zips,
      license_url
    }]);
    if (appErr) throw appErr;

    // ---- 3) UI success ----
    form.classList.add("hidden");
    successState.classList.remove("hidden");

    if (REQUIRES_EMAIL_CONFIRM) {
      showAlert("success", "Account created. Check your email to confirm, then log in. Your application was recorded.");
    } else {
      showAlert("success", "Account created and application submitted. You can log in now.");
    }
  } catch (err) {
    console.error(err);
    showAlert("error", err?.message || "Something went wrong. Try again.");
  }
});

// Optional: keep your localStorage role hint
try {
  const savedRole = localStorage.getItem("ts_selected_role");
  if (savedRole === "contractor") { /* any role-specific tweaks later */ }
} catch {}

</script>

</body>
</html>
